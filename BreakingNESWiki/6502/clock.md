# Тактовые сигналы

6502 включает в свой состав две схемы опорных тактовых сигналов: внешнюю и внутреннюю.

На вход процессора поступает один тактовый сигнал - `PHI0`, а на выход идут два тактовых сигнала - `PHI1` и `PHI2`.

Такой принцип работы основан на том, что каждый такт процессора состоит из двух "режимов" (или "стейтов"):
- PHI1=1: Установка адреса и режима R/W
- PHI2=1: Чтение/запись данных

Сигналы `PHI1` и `PHI2` называются полутактами и получаются из исходного тактового сигнала `PHI0` следующим образом:
- Когда `PHI0` имеет низкий уровень - сигнал `PHI1` имеет высокий уровень
- Когда `PHI0` имеет высокий уровень - сигнал `PHI2` также имеет высокий уровень

|PHI0|PHI1|PHI2|
|---|---|---|
|0|1|0|
|1|0|1|

Такой подход в организации распределения рабочего времени цикла нередкое явление среди старых процессоров и обычно называется "Dual-rail CLK".

## Схема для разводки тактовых сигналов внутрь

![clock_internal](/BreakingNESWiki/imgstore/6502/clock_internal.jpg)

Схема достаточно сложная, поскольку она не совсем "цифровая". Многочисленные транзисторы, выполняющие роль инверторов немного задерживают прохождение сигнала PHI0, поэтому сигналы PHI1 и PHI2, идущие внутрь процессора, немного "лагают". Вот логическое представление схемы:

![clock_internal_logic](/BreakingNESWiki/imgstore/6502/clock_internal_logic.jpg)

Логический анализ:

![clock_internal_logic_zero](/BreakingNESWiki/imgstore/6502/clock_internal_logic_zero.jpg)

![clock_internal_logic_one](/BreakingNESWiki/imgstore/6502/clock_internal_logic_one.jpg)

Развертка тактовых сигналов должна получиться примерно следующая:
- PHI1/PHI2 немного лагают относительно PHI0
- Нижний уровень PHI1/PHI2 немного длиннее верхнего, для того чтобы оба сигнала гарантированно не имели высокого уровня

![4672299](/BreakingNESWiki/imgstore/6502/waves/4672299.png)

Симуляция в Altera Quartus показывает "лаг", но не показывает удлиненный нижний уровень (он дорисован руками на картинке выше).

BigEd с форума 6502.org подсказал, что он проводил симуляцию на базе FPGA-нетлиста 6502 и получил следующие развертки:

![cclk-rising](/BreakingNESWiki/imgstore/6502/waves/cclk-rising.png)

![cclk-falling](/BreakingNESWiki/imgstore/6502/waves/cclk-falling.png)

Обозначение сигналов следующие: clk0 = PHI0, cp1 = PHI1, cclk = PHI2 (согласно нетлисту с Visual6502)

Схема, на которой базировалась его симуляция соответствует схеме из документации Балазца:

![clock_balazs](/BreakingNESWiki/imgstore/6502/clock_balazs.png)

http://forum.6502.org/viewtopic.php?f=8&t=2208&start=195

Выходит что из-за несимметричного каскада инвертора происходит затягивание нарастающего фронта, поэтому нижний уровень как-бы "затягивается".

Официальная документация приводит следующую диаграмму:

![clock_timing_datasheet](/BreakingNESWiki/imgstore/6502/clock_timing_datasheet.jpg)

Оптимизированная логическая схема:

![8_clock_internal](/BreakingNESWiki/imgstore/6502/ttlworks/8_clock_internal.png)

## Схема для разводки тактовых сигналов наружу

![clock_external](/BreakingNESWiki/imgstore/6502/clock_external.jpg)

Референсные сигналы PHI1/PHI2 также выдаются наружу для потребителей.

Логическая схема внешней разводки тактовых сигналов не отличается от схемы внутренней разводки, за исключением того, что выходы PHI1/PHI2 идут на одноименные контакты через "гребенку" мощных транзисторов.

## Почему PHI

В официальном даташите 6502 полу-такты называются "фазами", соответственно и название этих сигналов Φ1 и Φ2. Для унификации мы используем обозначения PHI1 и PHI2.
