# Сравнение спрайтов (OAM Evaluation)

![ppu_locator_sprite_eval](/BreakingNESWiki/imgstore/ppu/ppu_locator_sprite_eval.jpg)

Схема сравнения спрайтов занимается сравнением всех 64 спрайтов и выборкой первых 8 спрайтов, которые встречаются раньше всех на текущей строке (V). То что PPU умеет рисовать только первые 8 спрайтов строки - широко известный факт, который приходится учитывать при программировании NES. Обычно программисты применяют перемешивание спрайтов, но даже при этом возникает эффект "мерцания" спрайтов.

Выбранные спрайты помещаются в дополнительную память OAM2, откуда потом попадают для дальнейшей обработки в [OAM FIFO](fifo.md).

Схема включает в себя:
- Счётчик индекса OAM, для выборки следующего спрайта для сравнения
- Счётчик индекса OAM2, для сохранения результатов сравнения
- Схемы контроля счётчиками
- Компаратор, который выполняет операцию знакового вычитания (A - B)
- Схему управления сравнением, которая и реализует всю логику работы сравнения спрайтов

![OAM_Eval](/BreakingNESWiki/imgstore/ppu/OAM_Eval.png)

Таблица входных сигналов:

|Сигнал/группа|Описание|
|---|---|
|V0-7|Разряды счётчика V|
|O8/16|Object lines 8/16 (размер спрайта)|
|PPU FSM||
|BLNK|Активен когда рендеринг PPU отключен (сигналом `BLACK`) или во время VBlank|
|I/OAM2|"Init OAM2". Инициализировать дополнительную OAM|
|/VIS|"Not Visible". Невидимая часть сигнала (использует спрайтовая логика)|
|PAR/O|"PAR for Object". Выборка тайла для объекта (спрайта).|
|/EVAL|0: "Sprite Evaluation in Progress"|
|RESCL|Событие окончания периода VBlank|
|#F/NT|0: "Fetch Name Table"|
|S/EV|"Start Sprite Evaluation"|
|Разряды счётчика H с задержкой||
|H0'|Сигнал H0 задержанный одним DLatch|
|H0''|Сигнал H0 задержанный двумя DLatch|
|/H2'|Сигнал H2 задержанный одним DLatch (в инверсной логике)|
|CPU-интерфейс||
|/DBE|"Data Bus Enable", включение CPU интерфейса|
|/R2|Чтение регистра $2002|
|/W3|Запись в регистр $2003|
|OAM||
|OFETCH|"OAM Fetch"|
|OB0-7|Выходное значение OB|

Таблица выходных сигналов:

|Сигнал|Описание|
|---|---|
|/OAM0-7|Адрес OAM|
|OAM8|Выбирает дополнительную OAM для адресации|
|OAMCTR2|Управление OAM Buffer|
|SPR_OV|Спрайтов на текущей строке больше 8 или главный счётчик OAM переполнен, копирование прекращено|
|OV0-3|Разряды 0-3 значения V спрайта|
|PD/FIFO|Используется для дополнения FIFO безопасными значениями, если в результате сравнения количество спрайтов меньше 8|
|/SPR0_EV|0: Спрайт "0" найден на текущей строке|

Промежуточные сигналы:

|Сигнал|Описание|
|---|---|
|OMSTEP|Выполнить увеличение счётчика основной OAM (+1 или +4 определяется OMFG)|
|OMOUT|Хранить значение счётчика основной OAM|
|W3' (W3_Enable)|Команда записи $2003|
|OMV|Переполнение счётчика основной OAM|
|OAM0-7|Выходы счётчика основной OAM|
|OSTEP|Выполнить увеличение счётчика Temp OAM|
|ORES|Сбросить счётчик Temp OAM|
|TMV|Переполнение счётчика Temp OAM|
|OAMTemp0-4|Выходы счётчика Temp OAM|
|SPR_OV_Reg|Значение FF $2002\[5\]|
|COPY_OVF|Счётчик Джонсона, используемый для копирования спрайтов переполнен (все биты равны 0)|
|OVZ|Проверяемый спрайт находится на текущей строке|
|OMFG|"OAM Counter Mode4"|
|COPY_STEP|Выполнить шаг счётчика Джонсона|
|DO_COPY|Начать процесс копирования спрайта|

## Дополнительная схема H0''

Сигнал `H0''`, который используется в схемах управления счётчиками приходит не с выходов H-Output, которые находятся в схеме [PPU FSM](fsm.md), а получается схемой, которая находится в промежутке между соединениями левее спрайтовой логики.

Этот особенный сигнал `H0''` (но по сути - вариация обычного сигнала H0'') отмечен стрелочкой на транзисторных схемах.

![h0_dash_dash_tran](/BreakingNESWiki/imgstore/ppu/h0_dash_dash_tran.jpg)

## Разряд счётчиков

![OAM_CounterBit](/BreakingNESWiki/imgstore/ppu/OAM_CounterBit.png)

Используется типовая схема разряда счётчиков, с одним исключением: существует возможность "заблокировать" пересчёт разряда (`BlockCount`). 

Данная возможность используется только для разрядов 0 и 1 основного счётчика, чтобы реализовать режим пересчёта по модулю +4. Но блокирование пересчёта для младших разрядов приводит к тому, что для них перестаёт работать внутренняя цепочка переносов и поэтому в схему добавлена внешняя цепочка переносов для разрядов 2-7, которая используется в режиме Mode4.

## Счётчик индекса основной OAM

![oam_index_counter](/BreakingNESWiki/imgstore/ppu/oam_index_counter.jpg)

![OAM_MainCounter](/BreakingNESWiki/imgstore/ppu/OAM_MainCounter.png)

## Счётчик индекса Temp OAM (OAM2)

![oam2_index_counter](/BreakingNESWiki/imgstore/ppu/oam2_index_counter.jpg)

![OAM_TempCounter](/BreakingNESWiki/imgstore/ppu/OAM_TempCounter.png)

## Управление счётчиками

|Управление основным счётчиком|Управление счётчиком Temp OAM и схема переполнения спрайтов|
|---|---|
|![oam_index_counter_control](/BreakingNESWiki/imgstore/ppu/oam_index_counter_control.jpg)|![oam_counters_control](/BreakingNESWiki/imgstore/ppu/oam_counters_control.jpg)|

![OAM_CountersControl](/BreakingNESWiki/imgstore/ppu/OAM_CountersControl.png)

![OAM_SprOV_Flag](/BreakingNESWiki/imgstore/ppu/OAM_SprOV_Flag.png)

Режимы работы счётчиков OAM:

|Счётчик OAM|Разрядность (бит)|Модуль счета|Чтение/запись OAM регистрами $2003/$2004|Инициализация|Сравнение (поиск)|Сравнение (копирование)|Выборка спрайтов из Temp ОАМ в FIFO|
|---|---|---|---|---|---|---|---|
|OAM|8|+1 / +4|Работает, режим +1|Не работает|Работает, режим +4|Работает, режим +1|Не работает|
|Temp OAM|5|+1|Не работает|Работает|Не работает|Работает|Работает|

## Адрес OAM

![oam_address_tran](/BreakingNESWiki/imgstore/ppu/oam_address_tran.jpg)

![OAM_Address](/BreakingNESWiki/imgstore/ppu/OAM_Address.png)

## Компаратор

![oam_cmpr](/BreakingNESWiki/imgstore/ppu/oam_cmpr.jpg)

![OAM_CmpBitPair](/BreakingNESWiki/imgstore/ppu/OAM_CmpBitPair.png)

Чётные и нечётные разряды компаратора объединены в одну схему, для компактизации инвертированной цепочки переноса. Между "дуплетами" цепочка переноса сохраняется в прямой логике.

Так как схема является по сути вычитателем, то вместо "переноса" уместнее говорить "заём", но выражение "цепочка заёма" не принято и поэтому используется "цепочка переноса".

![OAM_Cmp](/BreakingNESWiki/imgstore/ppu/OAM_Cmp.png)

Открывающие транзисторы для входных защёлок находятся рядом с OAM Buffer:

![oam_buffer_readback](/BreakingNESWiki/imgstore/ppu/oam_buffer_readback.jpg)

## Схема управления сравнением

![oam_eval_control](/BreakingNESWiki/imgstore/ppu/oam_eval_control.jpg)

![OAM_EvalFSM](/BreakingNESWiki/imgstore/ppu/OAM_EvalFSM.png)

Конструкция из nor+mux+FF представляет собой Posedge DFFE. Причем вход `#EN` (enable) - в инверсной логике.

![PosedgeDFFE](/BreakingNESWiki/imgstore/ppu/PosedgeDFFE.png)

:warning: Обратите внимание, что в этой схеме вместо обычного `/PCLK` используется "Другой /PCLK" (`/PCLK2`), который получается на месте.
Практика и симуляция показала что такие "Другие CLK" важны для корректной работы схемы.
В данном случае этот сигнал означает что места, где применяется `/PCLK2` срабатывают немного позже, чем другие места, где применяется обычный `/PCLK`.

## PD/FIFO

Сигнал этот нужен когда активен PAR/O. В остальные моменты его срабатывание эффекта не даёт. Смысл его в запрете загрузки в FIFO артефакта сравнения спрайтов, при условии если спрайтов меньше 8, либо спрайты для текущей строки не были найдены. Появляется этот артефакт из-за упрощенной схемы копирования спрайтов из OAM в OAM2, ведь сигнал записи активен даже если копирование не начато. Получается в этой ячейке последнее значение из памяти при сравнении спрайтов. 

Иными словами, если PD/FIFO = 1, то загрузка паттерна из PD (H. INV) разрешена, 0 - запрещена.

## Большой конденсатор ("BigCap")

Сигнал `DO_COPY` подключен к большому конденсатору, одна обкладка которого сделано из куска полисиликона, а второй является подложка чипа (земля). Этот конденсатор нужен для небольшого затягивания фронта сигнала `DO_COPY`.