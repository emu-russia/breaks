# Object FIFO

![ppu_locator_fifo](/BreakingNESWiki/imgstore/ppu/ppu_locator_fifo.jpg)

Спрайтовый FIFO используется для временного хранения до 8 спрайтов, которые попали в текущую строку.

Хранится на самом деле не весь спрайт, а только одна его строка (8 пикселей), бит приоритета и 2 бита выбора палитры (атрибуты) и X-координата.

Примечание по поводу термина "FIFO": на самом деле в явном виде этот компонент так нигде не называется, но авторы посчитали использование этого термина удобным в перспективе очередности вывода спрайтов на экран. В патенте PPU эта схема упоминается как `Motion picture buffer memory`.

![FIFO_All](/BreakingNESWiki/imgstore/ppu/FIFO_All.png)

(открывайте картинку в новой вкладке для полного просмотра)

Таблица сигналов:

|Сигнал/группа сигналов|Описание|
|---|---|
|**Задержанные значения H**||
|H0'' - H2''|Используются для получения сигналов /SHx|
|H3'' - H5''|Используются для выбора лейна|
|**FSM**||
|PAR/O|"PAR for Object". Выборка тайла для объекта (спрайта)|
|0/HPOS|"Clear HPos". Очистить счётчики H в спрайтовой FIFO и начать работу FIFO|
|/VIS|"Not Visible". Невидимая часть сигнала (использует спрайтовая логика)|
|CLPO|1: Отсечение спрайтов.|
|**Из схемы сравнения спрайтов**||
|PD/FIFO|Для зануления выхода схемы H. Inv|
|**Внутренние сигналы**||
|/SH2|0: Загрузка атрибута спрайта|
|/SH3|0: Загрузка Х позиции в обратный счётчик|
|/SH5|0: Загрузка A байта спрайта в спаренный регистр сдвига|
|/SH7|0: Загрузка B байта спрайта в спаренный регистр сдвига|
|/Tx|Результат работы схемы H.INV, входное значение для загрузки в спаренный регистр сдвига (в инверсной логике)|
|#0/H|Производный сигнал от 0/HPOS|
|#x/EN|0: Лейн активен. Каждый лейн может активироваться индивидуально своим #EN сигналом.|
|**Выходные сигналы**||
|/SH2|Также используется в Data Reader|
|/SPR0HIT|Для определения события `Sprite 0 Hit`.|
|#ZCOL0, #ZCOL1, ZCOL2, ZCOL3, #ZPRIO|Результаты работы FIFO для мультиплексора (MUX)|

## Принцип работы

FIFO состоит из 8 "лейнов". Каждый лейн состоит из 3х частей: обратного счётчика пикселей, атрибутов спрайта и спаренного сдвигового регистра.

Обратный счётчик загружается горизонтальным смещением спрайта и тикает вниз до 0, одновременно с рендерингом пикселей. Как только счётчик достигает 0, это означает что можно начинать выводить пиксели спрайта.

В атрибутах хранится 2 бита выбора палитры спрайта и 1 бит приоритета над бэкграундом. Эти значения используются для всей выводимой строки.

Сдвиговый регистр используется для "выталкивания" очередной точки спрайта. А спаренный он потому что для точки используется 2 бита цветности.

Загружается спрайтовый FIFO из специальной служебной области OAM (та которая 32 байта), во время горизонтальной синхронизации (HBlank).

На схемах показан только лейн для спрайта #0. Все остальные лейны отличаются только названием сигналов.

![FIFO_Lane](/BreakingNESWiki/imgstore/ppu/FIFO_Lane.png)

## Схема контроля обратного счётчика

Показана схема для спрайта #0. Для всех остальных (1-7) нужно заменить название сигналов #0/EN на #x/EN.

![fifo_counter_control](/BreakingNESWiki/imgstore/ppu/fifo_counter_control.jpg)

![FIFO_CounterControl](/BreakingNESWiki/imgstore/ppu/FIFO_CounterControl.png)

## Обратный счётчик

![fifo_counter](/BreakingNESWiki/imgstore/ppu/fifo_counter.jpg)

![FIFO_CounterBit](/BreakingNESWiki/imgstore/ppu/FIFO_CounterBit.png)

![FIFO_DownCounter](/BreakingNESWiki/imgstore/ppu/FIFO_DownCounter.png)

## Схема контроля лейна

Показана схема для спрайта #0. Для всех остальных (1-7) нужно заменить название сигналов #0/EN, 0/COL2, 0/COL3 и 0/PRIO на #x/EN, x/COL2, x/COL3 и x/PRIO.

Кроме этого сигналы H3'', H4'' и H5'' используются как входы декодера 3-на-8, "размазанного"" по всем лейнам, для выбора соответствующих лейнов:

|Номер спрайта (лейн)|Логика сигналов H3'', H4'' и H5''|
|---|---|
|0|H3'' H4'' H5''| 
|1|/H3'' H4'' H5''|
|2|H3'' /H4'' H5''|
|3|/H3'' /H4'' H5''|
|4|H3'' H4'' /H5''|
|5|/H3'' H4'' /H5''|
|6|H3'' /H4'' /H5''|
|7|/H3'' /H4'' /H5''|

![fifo_attr](/BreakingNESWiki/imgstore/ppu/fifo_attr.jpg)

![FIFO_LaneControl](/BreakingNESWiki/imgstore/ppu/FIFO_LaneControl.png)

## Спаренный сдвиговый регистр

Показана схема для спрайта #0. Для всех остальных (1-7) нужно заменить название сигналов #0/COL0 и #0/COL1 на #x/COL0 и #x/COL1.

![fifo_sr](/BreakingNESWiki/imgstore/ppu/fifo_sr.jpg)

![FIFO_SRBit](/BreakingNESWiki/imgstore/ppu/FIFO_SRBit.png)

![FIFO_PairedSR](/BreakingNESWiki/imgstore/ppu/FIFO_PairedSR.png)

(открывайте картинку в новой вкладке для полного просмотра)

:warning: Значение подается на SR8 в реверснутом виде, т.к. пиксели выводятся задом наперёд.

## Схема приоритета спрайтов

Схема приоритета находится в "размазанном" виде. Ниже представлены отдельные куски этой схемы.
Схема представляет собой приоритетный шифратор (Priority encoder).

![fifo_prio0](/BreakingNESWiki/imgstore/ppu/fifo_prio0.jpg)

![fifo_prio1](/BreakingNESWiki/imgstore/ppu/fifo_prio1.jpg)

![fifo_prio2](/BreakingNESWiki/imgstore/ppu/fifo_prio2.jpg)

![fifo_prio3](/BreakingNESWiki/imgstore/ppu/fifo_prio3.jpg)

![fifo_prio4](/BreakingNESWiki/imgstore/ppu/fifo_prio4.jpg)

Результатом работы схемы (выходом) является сигнал `/SPR0HIT`, который уходит в соответствующую схему Sprite 0 Hit (см. [мультиплексор](mux.md))

![FIFO_Priority](/BreakingNESWiki/imgstore/ppu/FIFO_Priority.png)

(открывайте картинку в новой вкладке для полного просмотра)

## H. Inversion

![hinv](/BreakingNESWiki/imgstore/ppu/hinv.jpg)

HINV и HDIR - это два комплементарных сигнала (они никогда не могут принимать одинаковых значений). По сути эти два сигнала - это один управляющий сигнал мультиплексора, который выбирает способ выдачи разрядов шины PD. Если HINV = 1 - это означает что разряды шины PD выдаются в перевернутом виде на выходы `/T0-7`. Если HDIR = 1 - это означает что разряды шины PD выдаются в прямом виде на выходы `/T0-7`.

![H_Inversion](/BreakingNESWiki/imgstore/ppu/H_Inversion.png)

## Схема Sprite H

Также в состав FIFO было решено включить небольшую схему для получения значений `/SHx` (Sprite H). Схема находится выше мультиплексора, но большинство выходов `/SHx` используются только в Object FIFO (`/SH2` также используется в Data Reader).

![sprite_h](/BreakingNESWiki/imgstore/ppu/sprite_h.jpg)

![SpriteH](/BreakingNESWiki/imgstore/ppu/SpriteH.png)
